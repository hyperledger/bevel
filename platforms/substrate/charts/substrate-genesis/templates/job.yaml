##############################################################################################
#  Copyright Accenture. All Rights Reserved.
#
#  SPDX-License-Identifier: Apache-2.0
##############################################################################################

apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ $.Values.metadata.name }}"
  namespace: "{{ $.Values.metadata.namespace }}"
  labels:
    app.kubernetes.io/name: "{{ $.Values.metadata.name }}"
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    {{- include "labels.custom" . | nindent 2 }}
spec:
  backoffLimit: 6
  template:
    metadata:
      labels:
        app: "{{ $.Values.metadata.name }}"
        app.kubernetes.io/name: "{{ $.Values.metadata.name }}"
        app.kubernetes.io/instance: {{ .Release.Name }}
        {{- include "labels.custom" . | nindent 2 }}
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ $.Values.vault.serviceaccountname }}
      securityContext:
        fsGroup: 1000
      containers:
      - name: generate-genesis
        image: {{ $.Values.node.image }}
        imagePullPolicy: {{ $.Values.node.pullPolicy }}
        volumeMounts:
          - name: certcheck
            mountPath: /certcheck
        env:
        - name: VAULT_ADDR
          value: {{ $.Values.vault.address }}
        - name: KUBERNETES_AUTH_PATH
          value: {{ $.Values.vault.authpath }}
        - name: VAULT_APP_ROLE
          value: {{ $.Values.vault.role }}
        - name: MOUNT_PATH
          value: "/certcheck"
        - name: CERTS_SECRET_PREFIX
          value: {{ .Values.vault.certsecretprefix }}        
        - name: AURA_KEY
          value: {{ .Values.aura_key }}
        - name: GRANDPA_KEY
          value: {{ .Values.grandpa_key }}
        command: ["bash", "-c"]
        args:
        - |-
          #!/usr/bin/env bash
          apt-get update && apt-get install -y jq curl unzip;
          if [[ $? > 0 ]]
          then
            # download jq
            cd ~;
            curl -k -L -o jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64;
            chmod +x jq;
            export PATH=$PATH:.;
          else
            echo "jq and curl was installed using apt-get."
          fi;         

          validateVaultResponse () {
            if echo ${2} | grep "errors"; then
              echo "ERROR: unable to retrieve ${1}: ${2}"
              exit 1
            fi
            if  [ "$3" == "LOOKUPSECRETRESPONSE" ]
            then
              http_code=$(curl -sS -o /dev/null -w "%{http_code}" \
              --header "X-Vault-Token: ${VAULT_CLIENT_TOKEN}" \
              ${VAULT_ADDR}/v1/${vault_secret_key})
              curl_response=$?
              if test "$http_code" != "200" ; then
                  echo "Http response code from Vault - $http_code"
                  if test "$curl_response" != "0"; then
                     echo "Error: curl command failed with error code - $curl_response"
                     exit 1
                  fi
              fi
            fi
          }

          command={{ $.Values.node.command }}

          echo "Generate genesis"
          GENESIS=$($command build-spec --disable-default-bootnode --chain local)

          echo "Swapping chaintype and removing palletAura and grandpaAura authorities"
          GENESIS=$(echo $GENESIS | jq '.chainType |= "Live"')
          GENESIS=$(echo $GENESIS | jq '.genesis.runtime.palletAura.authorities |= []')
          GENESIS=$(echo $GENESIS | jq '.genesis.runtime.palletGrandpa.authorities |= []')

          echo "Inserting keys into genesis"

          echo "Inserting aura keys into genesis"
          {{- range .Values.aura_keys }}
          echo {{.}}
          GENESIS=$(echo "$GENESIS" | jq --arg aura {{.}} '.genesis.runtime.palletAura.authorities += [$aura]')
          {{- end }} 

          echo "Inserting grandpa keys into genesis"
          {{- range .Values.grandpa_keys }}
          echo {{.}}
          GENESIS=$(echo "$GENESIS" | jq --arg grandpa {{.}} '.genesis.runtime.palletGrandpa.authorities += [[$grandpa, 1]]')
          {{- end }}

          echo "$GENESIS" > genesis.json

          echo "Converting genesis to raw format"
          GENESIS=$($command build-spec --disable-default-bootnode --raw --chain ./genesis.json)
          echo "$GENESIS" > genesis_raw.json
          cat genesis_raw.json | base64 -w0 > genesis_base64

          KUBE_SA_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
          echo "Getting secrets from Vault Server: ${VAULT_ADDR}"

          # Login to Vault and so I can get an approle token
          export VAULT_TOKEN=$(curl -sS --request POST ${VAULT_ADDR}/v1/auth/${KUBERNETES_AUTH_PATH}/login \
            -H "Content-Type: application/json" \
            -d '{"role":"'"${VAULT_APP_ROLE}"'","jwt":"'"${KUBE_SA_TOKEN}"'"}' | \
            jq -r 'if .errors then . else .auth.client_token end')
          
          # the vault cli is required for this job as the genesis file is too large to be passed in via a vault api call
          echo "installing vault cli"
          curl -O -L https://releases.hashicorp.com/vault/1.7.1/vault_1.7.1_linux_amd64.zip
          unzip vault_1.7.1_linux_amd64.zip
          mv vault /bin

          validateVaultResponse 'vault login token' "${VAULT_CLIENT_TOKEN}"
          vault_secret_key="${CERTS_SECRET_PREFIX}/genesis"
          # Save the generated keys to VAULT
          vault kv put $vault_secret_key genesis=@genesis_base64
          
      volumes:
        - name: certcheck
          emptyDir:
            medium: Memory
